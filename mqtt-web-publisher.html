<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MQTT Web Publisher</title>
<style>
  body { font-family: ui-sans-serif, system-ui, Arial, sans-serif; margin: 16px; }
  h1 { margin-bottom: 8px; }
  fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
  legend { padding: 0 6px; font-weight: 600; }
  label { display:block; margin:6px 0 4px; font-size: 14px; }
  input, select, button, textarea { padding: 8px; font-size: 14px; }
  .row { display:flex; gap:8px; flex-wrap: wrap; }
  .row > * { flex: 1 1 160px; }
  #log { background:#0f172a; color:#e5e7eb; padding:12px; border-radius:8px; min-height:220px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .ok { color:#34d399; } .err { color:#f87171; } .muted { color:#9ca3af; }
</style>
</head>
<body>
  <h1>MQTT Web Publisher</h1>

  <fieldset>
    <legend>Conexão</legend>
    <div class="row">
      <div><label>Protocol</label><select id="proto"><option>ws</option><option>wss</option></select></div>
      <div><label>Host</label><input id="host" value="localhost"/></div>
      <div><label>Port</label><input id="port" value="9001"/></div>
      <div><label>Client ID</label><input id="clientId" placeholder="ex: aluno-pub-01"/></div>
      <div><label>Username</label><input id="username" value="aluno"/></div>
      <div><label>Password</label><input id="password" type="password" value="aluno123"/></div>
      <div style="align-self:end;"><button id="btnConnect">Conectar</button> <button id="btnDisconnect">Desconectar</button></div>
    </div>
    <small class="muted">Use <b>ws://host:9001</b> (ou <b>wss</b> com TLS). Client ID deve ser único.</small>
  </fieldset>

  <fieldset>
    <legend>Publish</legend>
    <div class="row">
      <div><label>Topic</label><input id="pubTopic" placeholder="ex: escola/lab01/esp32-01/tele/sensor"/></div>
      <div><label>QoS</label><select id="pubQos"><option>0</option><option>1</option><option>2</option></select></div>
      <div><label>Retain</label><select id="pubRetain"><option>false</option><option>true</option></select></div>
    </div>
    <label>Payload</label>
    <textarea id="pubPayload" rows="6" style="width:100%">{ "t": 28.5, "umid": 60 }</textarea>
    <div style="margin-top:8px;"><button id="btnPub">Publicar</button></div>
    <small class="muted">Dica: payload pode ser texto ou JSON. Se usar JSON, garanta que seja válido.</small>
  </fieldset>

  <fieldset>
    <legend>Console</legend>
    <div id="log"></div>
  </fieldset>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    let client = null;
    const logEl = document.getElementById('log');
    function log(msg, cls='') {
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML += (cls ? `<span class="${cls}">` : '') + `[${time}] ` + msg + (cls ? `</span>` : '') + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }
    const proto = document.getElementById('proto');
    const host = document.getElementById('host');
    const port = document.getElementById('port');
    const clientId = document.getElementById('clientId');
    const username = document.getElementById('username');
    const password = document.getElementById('password');
    const pubTopic = document.getElementById('pubTopic');
    const pubQos = document.getElementById('pubQos');
    const pubRetain = document.getElementById('pubRetain');
    const pubPayload = document.getElementById('pubPayload');

    document.getElementById('btnConnect').onclick = () => {
      if (client && client.connected) return log('Já conectado.', 'muted');
      const url = `${proto.value}://${host.value}:${port.value}`;
      const options = {
        username: username.value || undefined,
        password: password.value || undefined,
        clientId: clientId.value || ('pub-' + Math.random().toString(16).slice(2)),
        clean: true,
        keepalive: 60,
        protocolVersion: 4
      };
      log(`Conectando em ${url} como ${options.clientId} ...`, 'muted');
      client = mqtt.connect(url, options);
      client.on('connect', () => log('Conectado ✅', 'ok'));
      client.on('reconnect', () => log('Reconectando...', 'muted'));
      client.on('close', () => log('Conexão fechada.', 'muted'));
      client.on('error', (e) => log('Erro: ' + e.message, 'err'));
    };

    document.getElementById('btnDisconnect').onclick = () => {
      if (client) { client.end(true); log('Desconectando...', 'muted'); }
    };

    document.getElementById('btnPub').onclick = () => {
      if (!client || !client.connected) return log('Conecte primeiro.', 'err');
      const t = pubTopic.value.trim(); if (!t) return log('Topic é obrigatório.', 'err');
      const q = Number(pubQos.value); const r = (pubRetain.value === 'true');
      const payload = pubPayload.value;
      client.publish(t, payload, {qos: q, retain: r}, (err) => {
        if (err) log('PUB erro: ' + err.message, 'err');
        else log(`→ ${t} ${payload}`, 'ok');
      });
    };
  </script>
</body>
</html>
